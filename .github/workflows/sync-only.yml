name: Sync upstream (master) to fork

on:
  schedule:
    - cron: '*/15 * * * *' # –∑–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç
  workflow_dispatch:
    inputs:
      mode:
        description: '–†–µ–∂–∏–º –∑–∞–ø—É—Å–∫–∞: sync (–æ–±—ã—á–Ω—ã–π) –∏–ª–∏ test (—Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ)'
        required: false
        default: 'sync'

env:
  UPSTREAM_OWNER: muk-as
  UPSTREAM_REPO: DOTA2_WEB
  UPSTREAM_BRANCH: master
  FORK_BRANCH: master

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: üß© Checkout fork
        if: ${{ github.event.inputs.mode != 'test' }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üíæ Save current fork SHA
        if: ${{ github.event.inputs.mode != 'test' }}
        id: before
        run: echo "before_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: üîó Add upstream and fetch
        if: ${{ github.event.inputs.mode != 'test' }}
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_OWNER }}/${{ env.UPSTREAM_REPO }}.git || true
          git fetch --no-tags upstream

      - name: ‚öôÔ∏è Configure git identity
        if: ${{ github.event.inputs.mode != 'test' }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: üîÑ Merge upstream into fork branch
        if: ${{ github.event.inputs.mode != 'test' }}
        id: merge
        run: |
          git checkout ${{ env.FORK_BRANCH }} || git switch ${{ env.FORK_BRANCH }}
          if git merge --ff-only upstream/${{ env.UPSTREAM_BRANCH }} -m "Fast-forward merge upstream/${{ env.UPSTREAM_BRANCH }}" 2>/dev/null; then
            echo "merged=ff" >> $GITHUB_OUTPUT
          else
            git merge --no-edit upstream/${{ env.UPSTREAM_BRANCH }} || true
            echo "merged=merge" >> $GITHUB_OUTPUT
          fi

      - name: üíæ Save new SHA
        if: ${{ github.event.inputs.mode != 'test' }}
        id: after
        run: echo "after_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: üöÄ Compare SHAs and push if changed
        if: ${{ github.event.inputs.mode != 'test' }}
        id: push
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.before.outputs.before_sha }}" != "${{ steps.after.outputs.after_sha }}" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:${{ env.FORK_BRANCH }}
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: üì¢ Send Dota updates to Discord
        if: ${{ steps.push.outputs.changed == 'true' && github.event.inputs.mode != 'test' }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          echo "üì¢ Checking commits for Dota updates..."
          while read -r hash; do
            [ -z "$hash" ] && continue

            title=$(git show -s --format=%s $hash)
            body=$(git show -s --format=%b $hash)
            commit_url="https://github.com/${{ github.repository }}/commit/$hash"

            if echo "$title" | grep -iq "staging"; then
              type_update="Dota 2 Staging"
            elif echo "$title" | grep -iq "experimental"; then
              type_update="Dota 2 Experimental"
            elif echo "$title" | grep -iq "heroes"; then
              type_update="Dota 2 Heroes"
            else
              type_update="Dota 2 Update"
            fi

            added_lines=$(git show $hash | grep -E "^\+" | grep -vE "^\+\+\+|^---" | head -n 10)
            [ -z "$added_lines" ] && added_lines="(–º–µ–ª–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)"

            embed_desc=$(cat <<EOF
**–¢–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** ${type_update}
**–ß—Ç–æ –Ω–æ–≤–æ–≥–æ:**
${added_lines}
üîó [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–º–º–∏—Ç](${commit_url})
EOF
            )

            color=3447003
            json=$(jq -n \
              --arg title "Dota 2 Update" \
              --arg desc "$embed_desc" \
              --argjson color "$color" \
              '{embeds: [{title: $title, description: $desc, color: $color}]}')

            curl -s -H "Content-Type: application/json" \
                 -X POST -d "$json" "$DISCORD_WEBHOOK"

            echo "‚úÖ Sent update for $hash"
          done < <(git log --pretty=format:"%H" ${{ steps.before.outputs.before_sha }}..${{ steps.after.outputs.after_sha }} | tac)

      # üß™ –¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú
      - name: üß™ Send test Dota update to Discord
        if: ${{ github.event.inputs.mode == 'test' }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          echo "üß™ Starting test mode..."

          before_sha="aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
          after_sha="bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb"
          commit_url="https://github.com/${{ github.repository }}/commit/${after_sha}"
          type_update="Dota 2 Test Mode"

          added_lines=$(cat <<'EOF'
[v] test 12345 => 12346
[h] testhash123 => testhash456
[s] test CN hero => hero2
EOF
          )

          embed_desc=$(cat <<EOF
**–¢–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** ${type_update}
**–ß—Ç–æ –Ω–æ–≤–æ–≥–æ:**
${added_lines}
üîó [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–º–º–∏—Ç](${commit_url})
EOF
          )

          color=16776960

          json=$(jq -n \
            --arg title "üß™ Dota 2 Test Notification" \
            --arg desc "$embed_desc" \
            --argjson color "$color" \
            '{embeds: [{title: $title, description: $desc, color: $color}]}')

          echo "Debug JSON:"
          echo "$json"

          curl -s -H "Content-Type: application/json" \
               -X POST -d "$json" "$DISCORD_WEBHOOK" || echo "‚ö†Ô∏è Curl failed"

          echo "‚úÖ Test message sent successfully."
