name: Sync upstream (master) to fork

on:
  schedule:
    - cron: '*/15 * * * *' # ÐºÐ°Ð¶Ð´Ñ‹Ðµ 15 Ð¼Ð¸Ð½ÑƒÑ‚
  workflow_dispatch:
    inputs:
      mode:
        description: 'Ð ÐµÐ¶Ð¸Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° (sync Ð¸Ð»Ð¸ test)'
        required: false
        default: 'sync'

env:
  UPSTREAM_OWNER: muk-as
  UPSTREAM_REPO: DOTA2_WEB
  UPSTREAM_BRANCH: master
  FORK_BRANCH: master

jobs:
  sync:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: ðŸ§© Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ’¾ Save current fork SHA
        id: before
        run: echo "before_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: ðŸ”— Add upstream and fetch
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_OWNER }}/${{ env.UPSTREAM_REPO }}.git || true
          git fetch --no-tags upstream

      - name: âš™ï¸ Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: ðŸ”„ Merge upstream
        id: merge
        run: |
          git checkout ${{ env.FORK_BRANCH }} || git switch ${{ env.FORK_BRANCH }}
          if git merge --ff-only upstream/${{ env.UPSTREAM_BRANCH }} -m "Fast-forward merge"; then
            echo "merged=ff" >> $GITHUB_OUTPUT
          else
            git merge --no-edit upstream/${{ env.UPSTREAM_BRANCH }} || true
            echo "merged=merge" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ’¾ Save new SHA
        id: after
        run: echo "after_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: ðŸš€ Push if changed
        id: push
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.before.outputs.before_sha }}" != "${{ steps.after.outputs.after_sha }}" ]; then
            git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:${{ env.FORK_BRANCH }}
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¢ Send Dota updates to Discord
        if: steps.push.outputs.changed == 'true' || github.event.inputs.mode == 'test'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          set -euo pipefail

          # === Ð¢Ð•Ð¡Ð¢ÐžÐ’Ð«Ð™ Ð Ð•Ð–Ð˜Ðœ ===
          if [ "${{ github.event.inputs.mode }}" = "test" ]; then
            printf '%s\n' "**Ð¢Ð¸Ð¿ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ:** Dota 2 Test Mode" "" \
              "**Ð§Ñ‚Ð¾ Ð½Ð¾Ð²Ð¾Ð³Ð¾:**" \
              "[v] test 12345 => 12346" \
              "[h] testhash123 => testhash456" \
              "[s] test CN hero => hero2" "" \
              "ðŸ”— [ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚](https://github.com/AINewsAccount/DOTA2_WEB/commit/testhash)" > /tmp/desc.txt

            json=$(jq -n --rawfile desc /tmp/desc.txt \
              --arg title "ðŸ§ª Dota 2 Test Notification" \
              --argjson color 16776960 \
              '{embeds: [{title: $title, description: $desc, color: $color}]}')

            curl -sS -H "Content-Type: application/json" -X POST -d "$json" "$DISCORD_WEBHOOK"
            echo "âœ… Ð¢ÐµÑÑ‚Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾."
            exit 0
          fi

          # === ÐžÐ¡ÐÐžÐ’ÐÐžÐ™ Ð Ð•Ð–Ð˜Ðœ ===
          before="${{ steps.before.outputs.before_sha }}"
          after="${{ steps.after.outputs.after_sha }}"

          git log --pretty=format:"%H" "$before..$after" | tac | while read -r hash; do
            [ -z "$hash" ] && continue

            title=$(git show -s --format=%s "$hash")
            body=$(git show -s --format=%b "$hash")
            commit_url="https://github.com/${{ github.repository }}/commit/$hash"

            if echo "$title $body" | grep -iq "dota"; then
              if echo "$title" | grep -iq "staging"; then
                type_update="Dota 2 Staging"
              elif echo "$title" | grep -iq "experimental"; then
                type_update="Dota 2 Experimental"
              elif echo "$title" | grep -iq "heroes"; then
                type_update="Dota 2 Heroes"
              else
                type_update="Dota 2 Update"
              fi

              added_lines=$(git show "$hash" | grep -E "^\+" | grep -vE "^\+\+\+|^---" | head -n 10)
              [ -z "$added_lines" ] && added_lines="(Ð¼ÐµÐ»ÐºÐ¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ)"

              printf '%s\n' "**Ð¢Ð¸Ð¿ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ:** ${type_update}" "" \
                "**Ð§Ñ‚Ð¾ Ð½Ð¾Ð²Ð¾Ð³Ð¾:**" \
                "${added_lines}" "" \
                "ðŸ”— [ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚](${commit_url})" > /tmp/desc.txt

              json=$(jq -n --rawfile desc /tmp/desc.txt \
                --arg title "ðŸ“¢ Dota 2 Update" \
                --argjson color 3447003 \
                '{embeds: [{title: $title, description: $desc, color: $color}]}')

              curl -sS -H "Content-Type: application/json" -X POST -d "$json" "$DISCORD_WEBHOOK"
              echo "âœ… Sent update for $hash"
            fi
          done
