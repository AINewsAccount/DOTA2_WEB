name: Sync upstream (master) to fork
on:
  schedule:
    - cron: '*/15 * * * *' # –∑–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç
  workflow_dispatch:
    inputs:
      mode:
        description: '–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã (auto/test/resend –∏–ª–∏ resend -n X, –≥–¥–µ X - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–º–∏—Ç–æ–≤)'
        required: false
        default: 'auto'
env:
  UPSTREAM_OWNER: muk-as
  UPSTREAM_REPO: DOTA2_WEB
  UPSTREAM_BRANCH: master
  FORK_BRANCH: master
jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: üß© Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: üíæ Save current fork SHA
        id: before
        run: echo "before_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      - name: üîó Add upstream and fetch
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_OWNER }}/${{ env.UPSTREAM_REPO }}.git || true
          git fetch --no-tags upstream
      - name: ‚öôÔ∏è Configure git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
      - name: üîÑ Merge upstream into fork branch
        id: merge
        run: |
          git checkout ${{ env.FORK_BRANCH }} || git switch ${{ env.FORK_BRANCH }}
          if git merge --ff-only upstream/${{ env.UPSTREAM_BRANCH }} -m "Fast-forward merge upstream/${{ env.UPSTREAM_BRANCH }}" 2>/dev/null; then
            echo "merged=ff" >> $GITHUB_OUTPUT
            echo "‚úÖ Fast-forward merge –≤—ã–ø–æ–ª–Ω–µ–Ω."
          else
            echo "‚ÑπÔ∏è Fast-forward –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–±—ã—á–Ω—ã–π merge..."
            git merge --no-edit upstream/${{ env.UPSTREAM_BRANCH }} || true
            echo "merged=merge" >> $GITHUB_OUTPUT
          fi
      - name: üíæ Save new SHA
        id: after
        run: echo "after_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      - name: üöÄ Compare SHAs and push if changed
        id: push
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.before.outputs.before_sha }}" != "${{ steps.after.outputs.after_sha }}" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:${{ env.FORK_BRANCH }}
            echo "‚úÖ –§–æ—Ä–∫ —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å upstream."
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äî –≤—Å—ë —É–∂–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ."
          fi
      # -----------------------------------------------
      # üì¢ –û—Ç–ø—Ä–∞–≤–∫–∞ Discord —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫)
      # -----------------------------------------------
      - name: üì¢ Send Dota updates to Discord
        if: steps.push.outputs.changed == 'true' || github.event.inputs.mode != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          set -euo pipefail
          # set -x # –í–∫–ª—é—á–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è debug
          MODE="${{ github.event.inputs.mode || 'auto' }}"
          echo "üì¢ Mode: $MODE"
          # üß™ –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º
          if [[ "$MODE" == "test" ]]; then
            echo "üß™ Sending test message..."
            embed_title="üß™ Dota 2 Test Notification"
            embed_desc=$'**–¢–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** Dota 2 Test Mode\n\n**–ù–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ _HISTORY_by_date.txt:**\n‚Ä¢ –ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ —Å Dota 1\n‚Ä¢ –ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ —Å Dota 2\n\nüîó –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–º–º–∏—Ç'
            color=5814783
            jq -n \
              --arg title "$embed_title" \
              --arg desc "$embed_desc" \
              --argjson color "$color" \
              '{embeds: [{title: $title, description: $desc, color: $color}]}' \
            | curl -s -H "Content-Type: application/json" -X POST -d @- "$DISCORD_WEBHOOK"
            exit 0
          fi
          # -----------------------------
          # –°–∞–Ω–∞–π—Ç–∏–∑–∞—Ü–∏—è SHA
          # -----------------------------
          before_raw="${{ steps.before.outputs.before_sha }}"
          after_raw="${{ steps.after.outputs.after_sha }}"
          before=$(printf '%s' "$before_raw" | tr -d '\r\n' | awk '{$1=$1;print}')
          after=$(printf '%s' "$after_raw" | tr -d '\r\n' | awk '{$1=$1;print}')
          echo "DEBUG: before='$before' after='$after'"
          # -----------------------------
          # –ü–æ–ª—É—á–∞–µ–º upstream
          # -----------------------------
          git remote set-url upstream "https://github.com/${{ env.UPSTREAM_OWNER }}/${{ env.UPSTREAM_REPO }}.git" || true
          git fetch --no-tags upstream || true
          if ! git rev-parse "$before" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è SHA –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è fetch --unshallow..."
            git fetch --no-tags --unshallow upstream || true
            git fetch --no-tags upstream --depth=1000 || true
          fi
          # -----------------------------
          # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –∫–æ–º–º–∏—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ upstream)
          # -----------------------------
          range="$before..upstream/${{ env.UPSTREAM_BRANCH }}"
          echo "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω $range (—Ç–æ–ª—å–∫–æ upstream –∏–∑–º–µ–Ω–µ–Ω–∏—è)"
          log_range=$(git log --pretty=format:"%H" "$range" --reverse || true)
          if [ -z "${log_range:-}" ]; then
            echo "‚ö†Ô∏è log_range –ø—É—Å—Ç–æ–π ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –∫–æ–º–º–∏—Ç–æ–≤ –∏–∑ upstream."
            log_range=$(git log -n 5 --pretty=format:"%H" "upstream/${{ env.UPSTREAM_BRANCH }}" --reverse || true)
          fi
          # -----------------------------
          # –†–µ–∂–∏–º resend: –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–∏—Ç—ã —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ —Ñ–∞–π–ª–µ (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π -n X)
          # -----------------------------
          if [[ "$MODE" == resend* ]]; then
            echo "üîÅ –†–µ–∂–∏–º –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–æ–º–º–∏—Ç–æ–≤ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ _HISTORY_by_date.txt..."
            # –ü–∞—Ä—Å–∏–º –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π -n X (default 10)
            num_commits=10
            if [[ "$MODE" =~ -n\ ([0-9]+) ]]; then
              num_commits="${BASH_REMATCH[1]}"
            fi
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º -n $num_commits –∫–æ–º–º–∏—Ç–æ–≤."
            log_range=$(git log -n "$num_commits" --pretty=format:"%H" "upstream/${{ env.UPSTREAM_BRANCH }}" -- steam_api/_HISTORY_by_date.txt || true)
            if [ -z "$log_range" ]; then
              echo "‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∫–æ–º–º–∏—Ç–æ–≤, –∏–∑–º–µ–Ω—è—é—â–∏—Ö _HISTORY_by_date.txt ‚Äî –≤—ã—Ö–æ–¥–∏–º."
              exit 0
            fi
          fi
          echo "üîç –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–º–∏—Ç—ã..."
          for hash in $log_range; do
            [ -z "$hash" ] && continue
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º merge-–∫–æ–º–º–∏—Ç—ã
            if git show -s --format=%P "$hash" | grep -q ' '; then
              echo "‚ÑπÔ∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º merge-–∫–æ–º–º–∏—Ç: $hash"
              continue
            fi
            title=$(git show -s --format=%s "$hash" || true)
            commit_url="https://github.com/${{ env.UPSTREAM_OWNER }}/${{ env.UPSTREAM_REPO }}/commit/$hash"
            # -----------------------------
            # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¢–û–õ–¨–ö–û –Ω–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫ (+) –∏–∑ _HISTORY_by_date.txt, —Ñ–∏–ª—å—Ç—Ä –ø–æ "Dota"
            # -----------------------------
            new_lines=$(git show "$hash" -- steam_api/_HISTORY_by_date.txt 2>/dev/null \
              | grep "^\+" \
              | grep -vE "^\+\+\+" \
              | sed 's/^\+//' \
              | grep -i "dota" || true)  # –§–∏–ª—å—Ç—Ä –ø–æ —Å–ª–æ–≤—É "Dota" (case-insensitive)
            if [ -z "$new_lines" ]; then
              echo "‚ÑπÔ∏è –ù–µ—Ç –Ω–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫ —Å 'Dota' –≤ _HISTORY_by_date.txt –¥–ª—è $hash ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º."
              continue
            fi
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç—Ä–æ–∫ (Staging/Experimental/–æ–±—ã—á–Ω–æ–µ)
            type_update="Dota 2 Update"
            emoji="üîÑ"
            color=3066993  # –ó–µ–ª–µ–Ω—ã–π –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ
            if echo "$new_lines" | grep -iq "experimental"; then
              type_update="Dota 2 Experimental"
              emoji="üß™"
              color=16711680  # –ö—Ä–∞—Å–Ω—ã–π
            elif echo "$new_lines" | grep -iq "staging"; then
              type_update="Dota 2 Staging"
              emoji="üõ†Ô∏è"
              color=3447003  # –°–∏–Ω–∏–π
            elif echo "$title" | grep -iq "heroes"; then
              type_update="Dota 2 Heroes"
              emoji="ü¶∏"
              color=15844367  # –ó–æ–ª–æ—Ç–æ–π
            fi
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏
            formatted_new_lines=$(echo "$new_lines" | sed 's/^/‚Ä¢ /')
            # –§–æ—Ä–º–∏—Ä—É–µ–º desc –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–º–º–∏—Ç–∞
            embed_desc=$(printf '**–ö–æ–º–º–∏—Ç:** %s\n**–¢–∏–ø:** %s\n**–ù–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ _HISTORY_by_date.txt:**\n%s\nüîó [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å](%s)' "$title" "$type_update" "$formatted_new_lines" "$commit_url")
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π embed –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–º–∏—Ç–∞
            embed_title="$emoji $type_update"
            jq -n \
              --arg title "$embed_title" \
              --arg desc "$embed_desc" \
              --argjson color "$color" \
              '{embeds: [{title: $title, description: $desc, color: $color}]}' \
            | curl -s -H "Content-Type: application/json" -X POST -d @- "$DISCORD_WEBHOOK"
            echo "‚úÖ Sent update for $hash"
          done
