name: Sync upstream (master) to fork
on:
  schedule:
    - cron: '*/15 * * * *' # Ð·Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¶Ð´Ñ‹Ðµ 15 Ð¼Ð¸Ð½ÑƒÑ‚
  workflow_dispatch:
    inputs:
      mode:
        description: 'Ð ÐµÐ¶Ð¸Ð¼ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ (auto/test/resend Ð¸Ð»Ð¸ resend -n X, Ð³Ð´Ðµ X - ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð²)'
        required: false
        default: 'auto'
env:
  UPSTREAM_OWNER: muk-as
  UPSTREAM_REPO: DOTA2_WEB
  UPSTREAM_BRANCH: master
  FORK_BRANCH: master
jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ðŸ§© Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: ðŸ’¾ Save current fork SHA
        id: before
        run: echo "before_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      - name: ðŸ”— Add upstream and fetch
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_OWNER }}/${{ env.UPSTREAM_REPO }}.git || true
          git fetch --no-tags upstream
      - name: âš™ï¸ Configure git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
      - name: ðŸ”„ Merge upstream into fork branch
        id: merge
        run: |
          git checkout ${{ env.FORK_BRANCH }} || git switch ${{ env.FORK_BRANCH }}
          if git merge --ff-only upstream/${{ env.UPSTREAM_BRANCH }} -m "Fast-forward merge upstream/${{ env.UPSTREAM_BRANCH }}" 2>/dev/null; then
            echo "merged=ff" >> $GITHUB_OUTPUT
            echo "âœ… Fast-forward merge Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½."
          else
            echo "â„¹ï¸ Fast-forward Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶ÐµÐ½, Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ð¹ merge..."
            git merge --no-edit upstream/${{ env.UPSTREAM_BRANCH }} || true
            echo "merged=merge" >> $GITHUB_OUTPUT
          fi
      - name: ðŸ’¾ Save new SHA
        id: after
        run: echo "after_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      - name: ðŸš€ Compare SHAs and push if changed
        id: push
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.before.outputs.before_sha }}" != "${{ steps.after.outputs.after_sha }}" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:${{ env.FORK_BRANCH }}
            echo "âœ… Ð¤Ð¾Ñ€Ðº ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ñ upstream."
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ ÐÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ â€” Ð²ÑÑ‘ ÑƒÐ¶Ðµ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾."
          fi
      # -----------------------------------------------
      # ðŸ“¢ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Discord ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ (Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ð±Ð»Ð¾Ðº)
      # -----------------------------------------------
      - name: ðŸ“¢ Send Dota updates to Discord
        if: steps.push.outputs.changed == 'true' || github.event.inputs.mode != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          set -euo pipefail
          # set -x # Ð’ÐºÐ»ÑŽÑ‡Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð´Ð»Ñ debug
          MODE="${{ github.event.inputs.mode || 'auto' }}"
          echo "ðŸ“¢ Mode: $MODE"
          # ðŸ§ª Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼
          if [[ "$MODE" == "test" ]]; then
            echo "ðŸ§ª Sending test message..."
            embed_title="ðŸ§ª Dota 2 Test Notification"
            embed_desc=$'**Ð§Ñ‚Ð¾ Ð½Ð¾Ð²Ð¾Ð³Ð¾:**\nDota 2 Staging Server | [v] 3135 => 3136\nDota 2 Staging | [v] 3135 => 3136\n\n**Ð”Ð°Ñ‚Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ:** 2025-10-23 23:10:08\n**Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº:** [ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ](https://example.com/commit)'
            color=5814783
            jq -n \
              --arg title "$embed_title" \
              --arg desc "$embed_desc" \
              --argjson color "$color" \
              '{embeds: [{title: $title, description: $desc, color: $color}]}' \
            | curl -s -H "Content-Type: application/json" -X POST -d @- "$DISCORD_WEBHOOK"
            exit 0
          fi
          # -----------------------------
          # Ð¡Ð°Ð½Ð°Ð¹Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ñ SHA
          # -----------------------------
          before_raw="${{ steps.before.outputs.before_sha }}"
          after_raw="${{ steps.after.outputs.after_sha }}"
          before=$(printf '%s' "$before_raw" | tr -d '\r\n' | awk '{$1=$1;print}')
          after=$(printf '%s' "$after_raw" | tr -d '\r\n' | awk '{$1=$1;print}')
          echo "DEBUG: before='$before' after='$after'"
          # -----------------------------
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ upstream
          # -----------------------------
          git remote set-url upstream "https://github.com/${{ env.UPSTREAM_OWNER }}/${{ env.UPSTREAM_REPO }}.git" || true
          git fetch --no-tags upstream || true
          if ! git rev-parse "$before" >/dev/null 2>&1; then
            echo "âš ï¸ SHA Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ â€” Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ fetch --unshallow..."
            git fetch --no-tags --unshallow upstream || true
            git fetch --no-tags upstream --depth=1000 || true
          fi
          # -----------------------------
          # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ð° ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð² (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ upstream)
          # -----------------------------
          range="$before..upstream/${{ env.UPSTREAM_BRANCH }}"
          echo "âœ… Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½ $range (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ upstream Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ)"
          log_range=$(git log --pretty=format:"%H" "$range" --reverse || true)
          if [ -z "${log_range:-}" ]; then
            echo "âš ï¸ log_range Ð¿ÑƒÑÑ‚Ð¾Ð¹ â€” Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 5 ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð² Ð¸Ð· upstream."
            log_range=$(git log -n 5 --pretty=format:"%H" "upstream/${{ env.UPSTREAM_BRANCH }}" --reverse || true)
          fi
          # -----------------------------
          # Ð ÐµÐ¶Ð¸Ð¼ resend: Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹ Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÐ¼Ð¸ Ð² Ñ„Ð°Ð¹Ð»Ðµ (Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹ -n X)
          # -----------------------------
          if [[ "$MODE" == resend* ]]; then
            echo "ðŸ” Ð ÐµÐ¶Ð¸Ð¼ Ð¿ÐµÑ€ÐµÑÑ‹Ð»ÐºÐ¸ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð² Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÐ¼Ð¸ Ð² _HISTORY_by_date.txt..."
            # ÐŸÐ°Ñ€ÑÐ¸Ð¼ Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ -n X (default 10)
            num_commits=10
            if [[ "$MODE" =~ -n\ ([0-9]+) ]]; then
              num_commits="${BASH_REMATCH[1]}"
            fi
            echo "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ -n $num_commits ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð²."
            log_range=$(git log -n "$num_commits" --pretty=format:"%H" "upstream/${{ env.UPSTREAM_BRANCH }}" -- steam_api/_HISTORY_by_date.txt || true)
            if [ -z "$log_range" ]; then
              echo "âš ï¸ ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð², Ð¸Ð·Ð¼ÐµÐ½ÑÑŽÑ‰Ð¸Ñ… _HISTORY_by_date.txt â€” Ð²Ñ‹Ñ…Ð¾Ð´Ð¸Ð¼."
              exit 0
            fi
          fi
          echo "ðŸ” ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹..."
          for hash in $log_range; do
            [ -z "$hash" ] && continue
            # ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ merge-ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹
            if git show -s --format=%P "$hash" | grep -q ' '; then
              echo "â„¹ï¸ ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ merge-ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚: $hash"
              continue
            fi
            title=$(git show -s --format=%s "$hash" || true)
            commit_url="https://github.com/${{ env.UPSTREAM_OWNER }}/${{ env.UPSTREAM_REPO }}/commit/$hash"
            # -----------------------------
            # Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð¢ÐžÐ›Ð¬ÐšÐž Ð½Ð¾Ð²Ñ‹Ñ… ÑÑ‚Ñ€Ð¾Ðº (+) Ð¸Ð· _HISTORY_by_date.txt, Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ Ð¿Ð¾ "Dota"
            # -----------------------------
            new_lines=$(git show "$hash" -- steam_api/_HISTORY_by_date.txt 2>/dev/null \
              | grep "^\+" \
              | grep -vE "^\+\+\+" \
              | sed 's/^\+//' \
              | grep -i "dota" || true)  # Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ Ð¿Ð¾ ÑÐ»Ð¾Ð²Ñƒ "Dota" (case-insensitive)
            if [ -z "$new_lines" ]; then
              echo "â„¹ï¸ ÐÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ñ… ÑÑ‚Ñ€Ð¾Ðº Ñ 'Dota' Ð² _HISTORY_by_date.txt Ð´Ð»Ñ $hash â€” Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼."
              continue
            fi
            # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚Ð¸Ð¿ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÑÑ‚Ñ€Ð¾Ðº (Staging/Experimental/Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ðµ)
            type_update="Dota 2 Update"
            emoji="ðŸ”„"
            color=3066993  # Ð—ÐµÐ»ÐµÐ½Ñ‹Ð¹ Ð´Ð»Ñ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ð³Ð¾
            if echo "$new_lines" | grep -iq "experimental"; then
              type_update="Dota 2 Experimental"
              emoji="ðŸ§ª"
              color=16711680  # ÐšÑ€Ð°ÑÐ½Ñ‹Ð¹
            elif echo "$new_lines" | grep -iq "staging"; then
              type_update="Dota 2 Staging"
              emoji="ðŸ› ï¸"
              color=3447003  # Ð¡Ð¸Ð½Ð¸Ð¹
            elif echo "$title" | grep -iq "heroes"; then
              type_update="Dota 2 Heroes"
              emoji="ðŸ¦¸"
              color=15844367  # Ð—Ð¾Ð»Ð¾Ñ‚Ð¾Ð¹
            fi
            # ÐŸÐ°Ñ€ÑÐ¸Ð¼ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð´Ð»Ñ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ "Ð§Ñ‚Ð¾ Ð½Ð¾Ð²Ð¾Ð³Ð¾" Ð¸ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ Ð´Ð°Ñ‚Ñ‹ (Ð±ÐµÑ€Ñ‘Ð¼ Ð´Ð°Ñ‚Ñƒ Ð¸Ð· Ð¿ÐµÑ€Ð²Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸, Ð¿Ñ€ÐµÐ´Ð¿Ð¾Ð»Ð°Ð³Ð°Ñ Ð¾Ð½Ð¸ Ð¿Ð¾Ñ…Ð¾Ð¶Ð¸)
            changes=""
            date_update=""
            while IFS= read -r line; do
              # ÐŸÐ°Ñ€ÑÐ¸Ð¼: app_id - app_name | [v] from => to | date (UTC+3)
              app_name=$(echo "$line" | awk -F' - ' '{print $2}' | awk -F' \\| ' '{print $1}')
              version_change=$(echo "$line" | awk -F' \\| ' '{print $2}' | awk -F' \\| ' '{print $1}')
              date_raw=$(echo "$line" | awk -F' \\| ' '{print $3}' | sed 's/ (UTC+3)//')
              changes+="$app_name | $version_change\n"
              if [ -z "$date_update" ]; then
                date_update="$date_raw"
              fi
            done <<< "$new_lines"
            # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ desc
            embed_desc=$(printf '**Ð§Ñ‚Ð¾ Ð½Ð¾Ð²Ð¾Ð³Ð¾:**\n%s\n**Ð”Ð°Ñ‚Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ:** %s\n**Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº:** [ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ](%s)' "$changes" "$date_update" "$commit_url")
            # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ embed Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°
            embed_title="$emoji $type_update"
            jq -n \
              --arg title "$embed_title" \
              --arg desc "$embed_desc" \
              --argjson color "$color" \
              '{embeds: [{title: $title, description: $desc, color: $color}]}' \
            | curl -s -H "Content-Type: application/json" -X POST -d @- "$DISCORD_WEBHOOK"
            echo "âœ… Sent update for $hash"
          done
