name: Sync upstream (master) to fork
on:
  schedule:
    - cron: '*/15 * * * *' # Ğ·Ğ°Ğ¿ÑƒÑĞº ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚
  workflow_dispatch:
    inputs:
      mode:
        description: 'Ğ ĞµĞ¶Ğ¸Ğ¼ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ (auto/test/resend Ğ¸Ğ»Ğ¸ resend -n X, Ğ³Ğ´Ğµ X - ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¾Ğ²)'
        required: false
        default: 'auto'
env:
  UPSTREAM_OWNER: muk-as
  UPSTREAM_REPO: DOTA2_WEB
  UPSTREAM_BRANCH: master
  FORK_BRANCH: master
jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ§© Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: ğŸ’¾ Save current fork SHA
        id: before
        run: echo "before_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      - name: ğŸ”— Add upstream and fetch
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_OWNER }}/${{ env.UPSTREAM_REPO }}.git || true
          git fetch --no-tags upstream
      - name: âš™ï¸ Configure git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
      - name: ğŸ”„ Merge upstream into fork branch
        id: merge
        run: |
          git checkout ${{ env.FORK_BRANCH }} || git switch ${{ env.FORK_BRANCH }}
          if git merge --ff-only upstream/${{ env.UPSTREAM_BRANCH }} -m "Fast-forward merge upstream/${{ env.UPSTREAM_BRANCH }}" 2>/dev/null; then
            echo "merged=ff" >> $GITHUB_OUTPUT
            echo "âœ… Fast-forward merge Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½."
          else
            echo "â„¹ï¸ Fast-forward Ğ½ĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶ĞµĞ½, Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ merge..."
            git merge --no-edit upstream/${{ env.UPSTREAM_BRANCH }} || true
            echo "merged=merge" >> $GITHUB_OUTPUT
          fi
      - name: ğŸ’¾ Save new SHA
        id: after
        run: echo "after_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      - name: ğŸš€ Compare SHAs and push if changed
        id: push
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.before.outputs.before_sha }}" != "${{ steps.after.outputs.after_sha }}" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:${{ env.FORK_BRANCH }}
            echo "âœ… Ğ¤Ğ¾Ñ€Ğº ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ñ upstream."
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ ĞĞµÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ â€” Ğ²ÑÑ‘ ÑƒĞ¶Ğµ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾."
          fi

      # -----------------------------------------------
      # ğŸ“¢ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Discord ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
      # -----------------------------------------------
      - name: ğŸ“¢ Send Dota updates to Discord
        if: steps.push.outputs.changed == 'true' || github.event.inputs.mode != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          set -euo pipefail
          MODE="${{ github.event.inputs.mode || 'auto' }}"
          echo "ğŸ“¢ Mode: $MODE"

          if [[ "$MODE" == "test" ]]; then
            echo "ğŸ§ª Sending test message..."
            embed_title="ğŸ§ª Dota 2 Test Notification"
            embed_desc=$'**Ğ§Ñ‚Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾:**\nDota 2 Staging Server | [v] 3135 => 3136\nDota 2 Staging | [v] 3135 => 3136\n\n**Ğ”Ğ°Ñ‚Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ:** 2025-10-23 23:10:08\n**Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº:** [ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ](https://example.com/commit)'
            color=5814783
            jq -n \
              --arg title "$embed_title" \
              --arg desc "$embed_desc" \
              --argjson color "$color" \
              '{embeds: [{title: $title, description: $desc, color: $color}]}' \
            | curl -s -H "Content-Type: application/json" -X POST -d @- "$DISCORD_WEBHOOK"
            exit 0
          fi

          before_raw="${{ steps.before.outputs.before_sha }}"
          after_raw="${{ steps.after.outputs.after_sha }}"
          before=$(printf '%s' "$before_raw" | tr -d '\r\n' | awk '{$1=$1;print}')
          after=$(printf '%s' "$after_raw" | tr -d '\r\n' | awk '{$1=$1;print}')

          git remote set-url upstream "https://github.com/${{ env.UPSTREAM_OWNER }}/${{ env.UPSTREAM_REPO }}.git" || true
          git fetch --no-tags upstream || true

          if ! git rev-parse "$before" >/dev/null 2>&1; then
            git fetch --no-tags --unshallow upstream || true
            git fetch --no-tags upstream --depth=1000 || true
          fi

          range="$before..upstream/${{ env.UPSTREAM_BRANCH }}"
          log_range=$(git log --pretty=format:"%H" "$range" --reverse || true)

          if [ -z "${log_range:-}" ]; then
            log_range=$(git log -n 5 --pretty=format:"%H" "upstream/${{ env.UPSTREAM_BRANCH }}" --reverse || true)
          fi

          if [[ "$MODE" == resend* ]]; then
            num_commits=10
            if [[ "$MODE" =~ -n\ ([0-9]+) ]]; then
              num_commits="${BASH_REMATCH[1]}"
            fi
            log_range=$(git log -n "$num_commits" --pretty=format:"%H" "upstream/${{ env.UPSTREAM_BRANCH }}" -- steam_api/_HISTORY_by_date.txt || true)
            [ -z "$log_range" ] && exit 0
          fi

          echo "ğŸ” ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ñ‹..."
          for hash in $log_range; do
            [ -z "$hash" ] && continue
            if git show -s --format=%P "$hash" | grep -q ' '; then
              continue
            fi

            title=$(git show -s --format=%s "$hash" || true)
            commit_url="https://github.com/${{ env.UPSTREAM_OWNER }}/${{ env.UPSTREAM_REPO }}/commit/$hash"

            new_lines=$(git show "$hash" -- steam_api/_HISTORY_by_date.txt 2>/dev/null \
              | grep "^\+" \
              | grep -vE "^\+\+\+" \
              | sed 's/^\+//' \
              | grep -i "dota" || true)

            [ -z "$new_lines" ] && continue

            type_update="Dota 2 Update"
            emoji="ğŸ”„"
            color=3066993
            if echo "$new_lines" | grep -iq "experimental"; then
              type_update="Dota 2 Experimental"
              emoji="ğŸ§ª"
              color=16711680
            elif echo "$new_lines" | grep -iq "staging"; then
              type_update="Dota 2 Staging"
              emoji="ğŸ› ï¸"
              color=3447003
            elif echo "$title" | grep -iq "heroes"; then
              type_update="Dota 2 Heroes"
              emoji="ğŸ¦¸"
              color=15844367
            fi

            changes=""
            date_update=""
            while IFS= read -r line; do
              app_name=$(echo "$line" | awk -F' - ' '{print $2}' | awk -F' \\| ' '{print $1}')
              version_change=$(echo "$line" | awk -F' \\| ' '{print $2}' | awk -F' \\| ' '{print $1}')
              date_raw=$(echo "$line" | awk -F' \\| ' '{print $3}' | sed 's/ (UTC+3)//')
              changes+="${app_name} | ${version_change}\n"
              [ -z "$date_update" ] && date_update="$date_raw"
            done <<< "$new_lines"

            # âœ… Ğ¤Ğ¸ĞºÑ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ (Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑÑ‹ ÑÑ‚Ñ€Ğ¾Ğº)
            embed_desc=$(printf '**Ğ§Ñ‚Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾:**\n%s\n**Ğ”Ğ°Ñ‚Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ:** %s\n**Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº:** [ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ](%s)' "$changes" "$date_update" "$commit_url")

            embed_title="$emoji $type_update"

            jq -n \
              --arg title "$embed_title" \
              --arg desc "$embed_desc" \
              --argjson color "$color" \
              '{embeds: [{title: $title, description: $desc, color: $color}]}' \
            | curl -s -H "Content-Type: application/json" -X POST -d @- "$DISCORD_WEBHOOK"

            echo "âœ… Sent update for $hash"
          done
