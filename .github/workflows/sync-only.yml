name: Sync upstream (master) to fork

on:
  schedule:
    - cron: '*/15 * * * *' # –∑–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç
  workflow_dispatch: {} # —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é

env:
  UPSTREAM_OWNER: muk-as
  UPSTREAM_REPO: DOTA2_WEB
  UPSTREAM_BRANCH: master   # –≤–µ—Ç–∫–∞ –≤ –∞–ø—Å—Ç—Ä–∏–º–µ
  FORK_BRANCH: master       # –≤–µ—Ç–∫–∞ –≤ —Ñ–æ—Ä–∫–µ

jobs:
  sync:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã push —Å—Ä–∞–±–æ—Ç–∞–ª

    steps:
      - name: üß© Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã merge

      - name: üíæ Save current fork SHA
        id: before
        run: echo "before_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: üîó Add upstream and fetch
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_OWNER }}/${{ env.UPSTREAM_REPO }}.git || true
          git fetch --no-tags upstream

      - name: ‚öôÔ∏è Configure git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: üîÑ Merge upstream into fork branch
        id: merge
        run: |
          git checkout ${{ env.FORK_BRANCH }} || git switch ${{ env.FORK_BRANCH }}
          if git merge --ff-only upstream/${{ env.UPSTREAM_BRANCH }} -m "Fast-forward merge upstream/${{ env.UPSTREAM_BRANCH }}" 2>/dev/null; then
            echo "merged=ff" >> $GITHUB_OUTPUT
            echo "‚úÖ Fast-forward merge –≤—ã–ø–æ–ª–Ω–µ–Ω."
          else
            echo "‚ÑπÔ∏è Fast-forward –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–±—ã—á–Ω—ã–π merge..."
            git merge --no-edit upstream/${{ env.UPSTREAM_BRANCH }} || true
            echo "merged=merge" >> $GITHUB_OUTPUT
          fi

      - name: üíæ Save new SHA
        id: after
        run: echo "after_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: üöÄ Compare SHAs and push if changed
        id: push
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.before.outputs.before_sha }}" != "${{ steps.after.outputs.after_sha }}" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚¨ÜÔ∏è –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–π–¥–µ–Ω—ã ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è push..."
            git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:${{ env.FORK_BRANCH }}
            echo "‚úÖ –§–æ—Ä–∫ —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å upstream."
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äî –≤—Å—ë —É–∂–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ."
          fi

      - name: üì¢ Send Dota updates to Discord
        if: steps.push.outputs.changed == 'true'
        run: |
          updates=""
          while read -r hash; do
            if [ -z "$hash" ]; then continue; fi

            title=$(git show -s --format=%s $hash | sed 's/"/\\"/g')
            body=$(git show -s --format=%b $hash | sed 's/"/\\"/g')
            stats=$(git show --stat $hash | tail -n1 | sed 's/"/\\"/g')

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–º–º–∏—Ç —Å–≤—è–∑–∞–Ω —Å Dota
            if echo "$title $body" | grep -iq "Dota"; then

              # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤–µ—Ä—Å–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä "7197 => 7199")
              version_line=$(echo "$title $body" | grep -oE '[0-9]{3,6} *=> *[0-9]{3,6}' | head -n1 | sed 's/ //g')
              version_display=""
              if [ -n "$version_line" ]; then
                version_display="${version_line//=>/ => }"
              fi

              # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä "Dota 2 Experimental Server")
              update_name=$(echo "$title $body" | grep -oE 'Dota 2[^0-9]*' | sed 's/ *$//' | head -n1)

              # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –ø–æ —Ç–∏–ø—É
              color=3447003  # default blue
              if echo "$title $body" | grep -iq "Experimental"; then
                color=10181046  # purple
              elif echo "$title $body" | grep -iq "Staging"; then
                color=15105570  # orange
              fi

              # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏–π
              files_num=$(echo "$stats" | grep -oE '[0-9]+' | head -n1 || echo 0)
              changes="Files changed: ${files_num}"

              # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫, –µ—Å–ª–∏ –µ—Å—Ç—å
              source=""
              if echo "$title $body" | grep -iq "t.me"; then
                link=$(echo "$title $body" | grep -oE 'https://t\.me/[A-Za-z0-9_/-]+' | head -n1)
                source=" #steam_api | t.me/DOTA_DM"
              else
                source=" #steam_api | BOOST me"
              fi

              # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ (–±–ª–∏–∑–∫–æ –∫ —Ç–≤–æ–µ–º—É –ø—Ä–∏–º–µ—Ä—É)
              url="https://github.com/${{ github.repository }}/commit/$hash"
              desc="[v] ${update_name:-Dota 2 Update} ${version_display} ${changes} | CLICK to view CHANGES"

              # –î–æ–±–∞–≤–ª—è–µ–º –∫ updates
              if [ -n "$updates" ]; then
                updates="${updates} | "
              fi
              updates="${updates}${source} ${desc}"

            fi
          done < <(git log --no-merges --pretty=format:"%H" ${{ steps.before.outputs.before_sha }}..${{ steps.after.outputs.after_sha }} | tac)

          if [ -n "$updates" ]; then
            json=$(jq -n \
              --arg u "D–û–¢–ê_DM_SPAM: ${updates}" \
              '{content: $u}')

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Discord
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "$json" \
                 "${{ secrets.DISCORD_WEBHOOK }}"
          fi
